<!DOCTYPE html>
<html>
<head>
  <title>WMS Viewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" />
  <style>html, body, #map { height: 100%; margin: 0; }</style>
</head>
<body>
<div id="map"></div>

<script type="module">
import Map from 'https://cdn.jsdelivr.net/npm/ol@7.3.0/Map.js';
import View from 'https://cdn.jsdelivr.net/npm/ol@7.3.0/View.js';
import TileLayer from 'https://cdn.jsdelivr.net/npm/ol@7.3.0/layer/Tile.js';
import OSM from 'https://cdn.jsdelivr.net/npm/ol@7.3.0/source/OSM.js';
import TileWMS from 'https://cdn.jsdelivr.net/npm/ol@7.3.0/source/TileWMS.js';

const params = new URLSearchParams(window.location.search);
const workspace = params.get('workspace');
const layer = params.get('layer');


const token = localStorage.getItem('token');
console.log(`/api/wms?workspace=${workspace}&LAYERS=${workspace}:${layer}&TILED=true`);


const boundaryWmsSource = new TileWMS({
  url: `/wms?workspace=${workspace}`,
  params: {
    'LAYERS': `${workspace}:assam`,
    'TILED': true
  },
  serverType: 'geoserver',
  tileLoadFunction: (tile, src) => {
    fetch(src, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
      .then(res => res.blob())
      .then(blob => {
        tile.getImage().src = URL.createObjectURL(blob);
      });
  }
});
const boundaryWmsLayer = new TileLayer({ source: boundaryWmsSource });


// ----
const wmsSource = new TileWMS({
  url: `/wms?workspace=${workspace}`,
  params: {
    'LAYERS': `${workspace}:${layer}`,
    'TILED': true
  },
  serverType: 'geoserver',
  tileLoadFunction: (tile, src) => {
    fetch(src, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
      .then(res => res.blob())
      .then(blob => {
        tile.getImage().src = URL.createObjectURL(blob);
      });
  }
});

const wmsLayer = new TileLayer({ source: wmsSource });

const map = new Map({
  target: 'map',
  layers: [
    new TileLayer({ source: new OSM() }),
    boundaryWmsLayer,
    wmsLayer
  ],
  view: new View({
    center: [9310000, 2700000],
    zoom: 6
  })
});

// GetFeatureInfo on click
map.on('singleclick', function (evt) {
  const view = map.getView();
  const viewResolution = view.getResolution();

  const url = wmsLayer.getSource().getFeatureInfoUrl(
    evt.coordinate,
    viewResolution,
    'EPSG:3857',
    { 'INFO_FORMAT': 'application/json' }
  );

  if (url) {
    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (data.features.length > 0) {
          alert(JSON.stringify(data.features[0].properties, null, 2));
        } else {
          alert('No feature info found');
        }
      });
  }
});
</script>
</body>
</html>
